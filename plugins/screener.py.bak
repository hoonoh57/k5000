# -*- coding: utf-8 -*-
"""
plugins/screener.py  [MUTABLE]
==============================
종목 스크리닝: KOSPI 대비 베타/상관도 기반.
"""
from __future__ import annotations
from typing import List, Dict, Any
import numpy as np
import pandas as pd
import logging
from core.interfaces import IScreener, IDataSource
from core.types import Candidate

logger = logging.getLogger(__name__)


class BetaCorrelationScreener(IScreener):

    def screen(
        self,
        universe: List[str],
        index_df: pd.DataFrame,
        data_source: IDataSource,
        params: Dict[str, Any],
    ) -> List[Candidate]:
        top_n = params.get("screen_top_n", 10)
        min_vol = params.get("screen_min_volume", 500_000)
        min_beta = params.get("screen_min_beta", 0.8)
        min_corr = params.get("screen_min_corr", 0.5)

        if index_df is None or index_df.empty:
            return []

        idx_ret = index_df["close"].pct_change().dropna()
        candidates = []

        for code in universe:
            try:
                df = data_source.fetch_candles(code, "", "")
                if df is None or df.empty:
                    continue

                avg_vol = df["volume"].mean()
                if avg_vol < min_vol:
                    continue

                stk_ret = df["close"].pct_change().dropna()
                # 길이 맞추기
                min_len = min(len(idx_ret), len(stk_ret))
                if min_len < 20:
                    continue

                ir = idx_ret.iloc[-min_len:].values
                sr = stk_ret.iloc[-min_len:].values

                corr = np.corrcoef(ir, sr)[0, 1]
                if np.isnan(corr) or corr < min_corr:
                    continue

                idx_var = np.var(ir)
                beta = np.cov(sr, ir)[0, 1] / idx_var if idx_var > 0 else 0
                if beta < min_beta:
                    continue

                score = corr * beta * (avg_vol / 1_000_000)
                candidates.append(Candidate(
                    code=code, name="", score=score,
                    beta=beta, correlation=corr, avg_volume=avg_vol
                ))
            except Exception as e:
                logger.debug(f"Screening {code} failed: {e}")
                continue

        candidates.sort(key=lambda c: c.score, reverse=True)
        return candidates[:top_n]
