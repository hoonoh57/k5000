# -*- coding: utf-8 -*-
"""
plugins/signals.py  [MUTABLE]
=============================
매매 신호 생성: SuperTrend + JMA 조합.
매수: ST 상승추세 + JMA 상승전환 (선택적 JMA 기울기 필터)
매도: 목표수익 달성 + JMA 하락전환, 또는 ST 하락반전, 또는 손절
"""
from __future__ import annotations
from typing import List, Dict, Any
import numpy as np
from core.interfaces import ISignalGenerator
from core.types import Signal, Direction


class STJMASignalGenerator(ISignalGenerator):

    def generate(self, df, code: str, params: Dict[str, Any]) -> List[Signal]:
        signals: List[Signal] = []

        target_pct = params.get("target_profit_pct", 7.0)
        stop_pct = params.get("stop_loss_pct", -5.0)
        jma_slope_min = params.get("jma_slope_min", 0.0)

        # 필수 컬럼 확인
        for col in ["st_dir", "jma", "jma_slope", "close"]:
            if col not in df.columns:
                return signals

        st_dir = df["st_dir"].values
        jma = df["jma"].values
        jma_slope = df["jma_slope"].values
        close = df["close"].values
        dates = df["date"].values if "date" in df.columns else df.index

        n = len(close)
        in_position = False
        entry_price = 0.0

        for i in range(2, n):
            dt = dates[i]

            if not in_position:
                # ── 매수 조건 ──
                # 1) ST 상승추세
                if st_dir[i] != 1:
                    continue

                # 2) JMA 상승전환: 전일 기울기 ≤ 0, 금일 기울기 > 0
                jma_turn_up = (jma_slope[i - 1] <= 0 and jma_slope[i] > 0)
                if not jma_turn_up:
                    continue

                # 3) 선택적 JMA 기울기 필터
                if jma_slope_min > 0:
                    slope_pct = abs(jma_slope[i]) / close[i] * 100 if close[i] > 0 else 0
                    if slope_pct < jma_slope_min:
                        continue

                signals.append(Signal(
                    direction=Direction.BUY,
                    code=code, dt=dt, price=close[i],
                    reason=f"ST_UP + JMA_TURN_UP (slope={jma_slope[i]:.2f})"
                ))
                in_position = True
                entry_price = close[i]

            else:
                # ── 매도 조건 ──
                if entry_price <= 0:
                    continue

                pnl_pct = (close[i] / entry_price - 1) * 100

                # 1) 손절 (항상 활성)
                if pnl_pct <= stop_pct:
                    signals.append(Signal(
                        direction=Direction.SELL,
                        code=code, dt=dt, price=close[i],
                        reason=f"STOP_LOSS ({pnl_pct:.1f}%)"
                    ))
                    in_position = False
                    entry_price = 0.0
                    continue

                # 2) ST 하락반전 → 즉시 매도
                if st_dir[i] == -1:
                    signals.append(Signal(
                        direction=Direction.SELL,
                        code=code, dt=dt, price=close[i],
                        reason=f"ST_DOWN ({pnl_pct:.1f}%)"
                    ))
                    in_position = False
                    entry_price = 0.0
                    continue

                # 3) 목표수익 달성 + JMA 하락전환 → 매도
                if pnl_pct >= target_pct:
                    jma_turn_down = (jma_slope[i - 1] >= 0 and jma_slope[i] < 0)
                    if jma_turn_down:
                        signals.append(Signal(
                            direction=Direction.SELL,
                            code=code, dt=dt, price=close[i],
                            reason=f"TARGET+JMA_DOWN ({pnl_pct:.1f}%)"
                        ))
                        in_position = False
                        entry_price = 0.0
                        continue
                    # 목표 달성했지만 JMA 아직 상승 → 보유 유지

                # 4) 목표 미달 + ST 상승 유지 → 보유 유지

        return signals
